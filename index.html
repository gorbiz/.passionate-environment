<!DOCTYPE html>
<html>
<head>
	<title>.passionate-environment</title>

	<script src="http://www.passionismandatory.com/libs/ace/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>

	<script type="text/javascript">

		/**
		 * Some options,
		 * all are to be passed via the URL.
		 *
		 * Edit a specific file:
		 * &file=<filename>
		 *
		 * Hide the editor on load (fullscreen mode):
		 * &fullscreen=yes
		 * Exit fullscreen mode by mousing over left edge of the screen.
		 *
		 * Turn off the html valiator:
		 * &validator_url=none
		 *
		 * Specify a html validator to use (compatible with validator.nu):
		 * &validator_url=<url to validator>
		 * Example: &validator_url=http://localhost:8888
		 */

		function get_url_vars() {
			var vars = {};
			var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
				vars[key] = value;
			});
			return vars;
		}
		function get_unknown_url_vars_as_string() {
			var unknown = {};
			var vars = get_url_vars();
			for (key in vars) {
				if (key != 'validator_url' && key != 'file' && key != 'fullscreen' && key != 'theme' && key != 'render_url') {
					unknown[key] = vars[key];
				}
			}
			var tmp = [];
			for (key in unknown) {
				tmp.push(key + '=' + unknown[key]);
			}
			return tmp.join('&');
		}

		var file_to_edit;
		if (get_url_parameter('file') != 'null') {
			file_to_edit = get_url_parameter('file');
		} else {
			$.get('find_file.php', {nocache: new Date().getTime()}, function(data) {
				file_to_edit = data;
				setup_editor_for(file_to_edit);
			});
		}

		/*
		 * Instead of simply rendering the file you are editing in the
		 * right hand side iframe you can render any URL you want.
		 * Useful when editing CSS, JavaScript or when deling with
		 * front controlled systems like Drupal or WordPress.
		 */
		var render_url = null;
		if (get_url_parameter('render_url') != 'null') {
			render_url = decodeURIComponent(get_url_parameter('render_url'));
		}

		var show_only_page_on_load = (get_url_parameter('fullscreen') != 'null');

		var run_delay = 1000;

		var project_url = get_project_url();

		var validator_url = "http://validator.nu/";
		if (get_url_parameter('validator_url') != 'null') {
			// TODO Maybe this could be stored in a cookie for convenience?
			validator_url = get_url_parameter('validator_url');
		}
		/*
		 * TODO else if on localhost/local network check if localhost:8888
		 * appears to be a validator, if so; use it.
		 * if not, show a friendly warning.
		 */

		function get_project_url() {
			var clear_url = window.location.href.split('?')[0].slice(0, -1);
			return clear_url.substr(0, clear_url.lastIndexOf('/') + 1);
		}

		function get_url_parameter(name) {
			return decodeURI(
				(RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
			);
		}

		var available_themes = [
			"clouds",
			"clouds_midnight",
			"cobalt",
			"crimson_editor",
			"dawn",
			"eclipse",
			"idle_fingers",
			"kr_theme",
			"merbivore",
			"merbivore_soft",
			"mono_industrial",
			"monokai",
			"pastel_on_dark",
			"twilight",
			"vibrant_ink"];		
		var theme = "twilight";
		var passed_theme = get_url_parameter('theme');
		if (passed_theme != 'null') {
			if (available_themes.indexOf(passed_theme) > -1) {
				theme = passed_theme;
			} else {
				console.warn('Warning: Unknown theme provided "' + passed_theme + '"');
			}
		}



		var editor;
		$(document).ready(function() {
			// Prevent bullies such as Google Maps to steal the focus, forever.
			$("#editor").click(function() {
				window.focus();
			});

			editor = ace.edit("editor");
			$.getScript("http://www.passionismandatory.com/libs/ace/theme-" + theme + ".js", function() {
				editor.setTheme("ace/theme/" + theme);
			});

			editor.setShowPrintMargin(false);

			// The outputed file will use real tabs
			editor.getSession().setUseSoftTabs(false);

			// Without this, hitting the home button doesn't scroll all the way 
			editor.renderer.setPadding(0);

			if (file_to_edit) {
				setup_editor_for(file_to_edit);
			}

			if (show_only_page_on_load) {
				show_only_page();
			}



			$("#errors").mouseover(function() {
				show_errors();
			});
			$("#errors").mouseout(function() {
				hide_errors();
			});

			$("#output").mouseover(function() {
				show_output();
			});
			$("#output").mouseout(function() {
				hide_output();
			});

			$("iframe#iframe").load(function() {
				update_errors();
			});

			// FIXME When going right, toggling browser fullscreen and then going left the editor is all white (resizing the window brings it's content back...)
			$("#toggle-right").mouseover(function() {
				show_only_page();
			});

			$("#toggle-left").mouseover(function() {
				show_normal_view();
			});

		});

		function show_only_page() {
			$("#editor").css("width", 0);
			$("#iframe").css("left", 1);
			$("#iframe").css("width", 1679);
		}

		function show_normal_view() {
			$("#editor").css("width", 631);
			$("#iframe").css("left", 632);
			$("#iframe").css("width", 1047);
			editor.resize();
		}

		function setup_editor_for(file) {
			get_mode_for_extension(get_file_extenstion(file), function(mode) {
				editor.getSession().setMode(new mode());
			});
			
			refresh_page();
			$.get('get.php', {file: file, nocache: new Date().getTime()}, function(data) {
				editor.getSession().setValue(data);
				// XXX I put this in here so that the editor will not save the file just after loading it...
				editor.getSession().on('change', function() {
					code_changed();
					run_unintrusive();
				});
				editor.getSession().selection.on('changeCursor', abort_run);
			});
		}
		
		function get_mode_for_extension(extension, callback) {
			extension = extension.toLowerCase();
			var mode_name = 'html';
			if (['html', 'js', 'css', 'php'].indexOf(extension) > -1) {
				mode_name = (extension == 'js') ? 'javascript' : extension;
			}
			$.getScript("http://www.passionismandatory.com/libs/ace/mode-" + mode_name + ".js", function() {
				callback(require("ace/mode/" + mode_name).Mode);
			});			
		}

		function get_file_extenstion(filename) {
			return (/[.]/.exec(filename)) ? /[^.]+$/.exec(filename)[0] : undefined;
		}

		var code_has_changed = false;
		function code_changed() {
			code_has_changed = true;
		}

		var run_unintrusive_timer;
		function run_unintrusive() {
			clearTimeout(run_unintrusive_timer);
			run_unintrusive_timer = setTimeout(run, run_delay);
		}

		function run() {
			code_has_changed = false;
			var data = editor.getSession().getValue();
			$.post("put.php", { file: file_to_edit, data: data }, function(data) {
				if (data.length) {
					alert("Got an unexpected response: " + data);
					return false;
				} else {
					refresh_page();
				}
			});
		}

		function refresh_page() {
			$("#iframe").attr('src', get_url_to_render());
		}

		function get_url_to_render(absolute_url) {
			var absolute_url = (typeof absolute_url == "undefined") ? false : absolute_url;
                        var passedParams = '';
                        if (get_unknown_url_vars_as_string()) {
                                passedParams = '&' + get_unknown_url_vars_as_string();
                        }
                        if (render_url) {
                                // FIXME Serious issue we don't know if the URL has a query part or not, we simply assume so... This is something that will fail 50% o$
                                return render_url + '&random=' + (new Date().getTime()) + passedParams;
                        } else {
				if (absolute_url) {
					var base_url = project_url + '/' + file_to_edit
				} else {
					var base_url = '../' + file_to_edit;
				}
				return base_url + '?random=' + (new Date().getTime()) + passedParams;
                        }
		}

		function abort_run() {
			clearTimeout(run_unintrusive_timer);
			if (code_has_changed) {
				run_unintrusive_timer = setTimeout(run, run_delay);
			}
		}

		function update_output() {
			$.get('output.log', function(data) {
				$("#output").html(data);
				if (data.length) {
					//show_output();
				} else {
					hide_output();
				}
			});
		}

		function update_errors() {
			if (validator_url == 'none') return;
			// FIXME This does not work (it ignores) render_url
			validate_html5(get_url_to_render(true), function(data) {
				$("#errors-html").html(format_errors(data));
				if (data.length) {
					show_errors();
				} else {
					hide_errors_if_empty();
				}
			});
		}

		function validate_html5(url, callback) {
			$.ajax({
				url: validator_url,
				data: { doc: url, out: 'json', nocache: new Date().getTime() },
				success: function(result) {
					// FIXME Do propper error handling here!
					if (result.messages[0].type == 'non-document-error') {
						console.log('ERROR: Failed to validate, maybe you are using an external validator from localhost?');
						return;
					}
					callback(
						result.messages
						.filter(function(message) { return message.type != 'info'; })
						// Ignore these messages about meta tags as the validator fails fo validate them correctly
						.filter(function(message) { return !/Attribute .?property.? not allowed on element .?meta.?/.test(message.message); })
						.filter(function(message) { return !/Element .?meta.? is missing one or more of the following attributes/.test(message.message); })
						.map(function(message) {
								return "<strong>" + message.type.charAt(0).toUpperCase() + message.type.substr(1) + ":</strong>" + message.message + "<br />" 
									+ "From line " + message.firstLine + ", column" + message.firstColumn + "; to line " + message.lastLine + ", column " + message.lastColumn + "<br />"
									// Lazy man's encode html entities
									+ "<strong>" + $("<div/>").text(message.extract).html() + "</strong><br />";
						}).join('<br />'));
				},
				error: function(error) {
					// FIXME Do propper error handling here!
					console.log('ERROR: Failed to validate, maybe you are using an external validator from localhost?');
				}
			});
		}

		// Makes goto line links in texts like 'File "test.py", line 156, in'
		function format_errors(errors) {
			errors = errors.replace(/line\s([0-9]+)/gi, "<a href=\"javascript:goto_line($1);\">line $1</a>");
			return errors;
		}

		function goto_line(line_number) {
			editor.gotoLine(line_number);
		}

		function show_output() {
			$("#output").height('300px');
			$("#output").width('630px');
		}
		function hide_output() {
			$("#output").height('300px');
			$("#output").width('5px');
		}

		function show_errors() {
			$("#errors").height('300px');
		}
		function hide_errors() {
			$("#errors").height('1px');
		}

		function hide_errors_if_empty() {
			if ($(".errors").html().length == 0) {
				hide_errors();
			}
		}
	</script>

	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
		}
		pre {
			margin: 0;
		}
		#editor {
			position: absolute;
			width: 631px;
			height: 100%;
			/* And make room for the left hand side toggle */
			left: 1px;
		}
		#iframe {
			position: absolute;
			left: 632px;
			top: 0;
			width: 1047px;
			height: 100%;

			border: 0;
		}
		#output, #errors {
			z-index: 1001;
			font-family: Helvetica, Arial, sans-serif;
		}
		#output {
			position: absolute;
			top: 0;
			right: 0;
			width: 5px;
			height: 300px;

			background: #afa;

			overflow: auto;

			/* XXX Remove for now */
			display: none;
		}
		#errors {
			position: absolute;
			bottom: 0;
			left: 632px;
			width: 648px;
			height: 1px;

			overflow: auto;

			background: #ffa;
			border-top: 1px solid #aaa;
		}
		#errors-html {
			margin-top: 0;
			padding-top: 1em;
			padding-left: 1em;
			padding-right: 1em;
		}
		#errors-html {
			background: #ffa;
		}

		#toggle-left, #toggle-right {
			position: absolute;
			top: 0;
			width: 1px;
			height: 100%;
			background: white;
		}
		#toggle-left {
			left: 0;
		}
		#toggle-right {
			right: 0;
		}
	</style>
</head>

<body>
	<pre id="output"></pre>
	
	<iframe id="iframe"></iframe>
	
	<div id="errors">
		<div id="errors-code" class="errors"></div>
		<div id="errors-html" class="errors"></div>
	</div>
	
	<div id="editor">code goes here</div>
	
	<div id="toggle-left"></div>
	<div id="toggle-right"></div>	
</body>
</html>
